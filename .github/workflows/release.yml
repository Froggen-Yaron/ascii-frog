name: ğŸš€ ASCII-Frog Release

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Release
    runs-on: linux-amd64
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
        
    #############################################
    ########## Injected By Fly Desktop ##########

    - name: Setup JFrog Fly
      uses: Frog-Gen/fly-action@v1
      with:
        url: https://p1-flylnp1.jfrogdev.org

    ########## Injected By Fly Desktop ##########
    #############################################
        
    - name: ğŸ“¦ Install workspace dependencies
      run: |
        echo "ğŸ“¦ Installing workspace dependencies..."
        npm install
        
    - name: ğŸ—ï¸ Build frontend
      run: |
        echo "ğŸ—ï¸ Building frontend..."
        npm run build
        
    - name: ğŸ“¤ Publish Backend NPM package
      run: |
        NPM_VERSION=$(jq -r .version < package.json)
        echo "ğŸ“¦ Publishing backend package version: $NPM_VERSION"
        cd backend && npm publish
        echo "âœ… Backend package published successfully"
        
    - name: ğŸ“¤ Publish Frontend NPM package
      run: |
        NPM_VERSION=$(jq -r .version < package.json)
        echo "ğŸ“¦ Publishing frontend package version: $NPM_VERSION"
        cd frontend && npm publish
        echo "âœ… Frontend package published successfully"
        
    - name: ğŸ³ Build and Push Docker image
      run: |
        VERSION=$(date +"%Y.%m.%d-%H.%M.%S")
        echo "ğŸ“¦ Building and pushing Docker version: $VERSION"
        
        echo ${{ secrets.FLY_TOKEN }} | docker login -u admin p1-flylnp1.jfrogdev.org --password-stdin
        
        # Build the Docker image (frontend already built in previous step)
        echo "ğŸ—ï¸ Building Docker image..."
        docker build -t p1-flylnp1.jfrogdev.org/docker/ascii-frog:$VERSION .
        
        # Push the Docker image
        echo "ğŸ“¤ Pushing Docker image..."
        docker push p1-flylnp1.jfrogdev.org/docker/ascii-frog:$VERSION
          
        echo "âœ… Docker image pushed successfully"
        


