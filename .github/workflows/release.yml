name: ğŸ¸ ASCII Frog Demo Pipeline

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]

jobs:
  # Simple Test and Docker Build
  build:
    name: ğŸ§ª Test & Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Start server for testing
      run: |
        npm start &
        sleep 5
        
    - name: ğŸ©º Run tests
      run: |
        npm test
        npm run test:api
      
    - name: ğŸ³ Build Docker image
      if: github.event_name == 'push'
      run: docker build -t ascii-frog:latest .
      
    - name: ğŸ·ï¸ Login to GitHub Container Registry
      if: github.event_name == 'push'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸš€ Push Docker image
      if: github.event_name == 'push'
      run: |
        docker tag ascii-frog:latest ghcr.io/${{ github.repository }}:latest
        docker push ghcr.io/${{ github.repository }}:latest
        
        if [[ ${{ github.ref }} == refs/tags/* ]]; then
          docker tag ascii-frog:latest ghcr.io/${{ github.repository }}:${{ github.ref_name }}
          docker push ghcr.io/${{ github.repository }}:${{ github.ref_name }}
        fi

  # Simple Release Creation (only for tags)
  release:
    name: ğŸ‰ Create Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ¯ Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: ğŸ¸ FrogGen Demo ${{ github.ref_name }}
        body: |
          ## ğŸ‰ ASCII Frog Generator Demo Release
          
          ### ğŸš€ Quick Start
          ```bash
          # Run with Docker
          docker run -p 3000:3000 ghcr.io/${{ github.repository }}:${{ github.ref_name }}
          
          # Or with Docker Compose
          docker-compose up -d
          ```
          
          Visit: http://localhost:3000
        draft: false
        prerelease: false
