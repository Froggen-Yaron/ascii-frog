name: ðŸš€ ASCII-Frog Release

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Release
    runs-on: fly-scale-set-runner-default
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup JFrog Fly
      uses: FrogGen/fly-action@v1
      with:
        url: https://p1-flylnp1.jfrogdev.org
        
    - name: ðŸš€ Publish NPM package
      run: |
        NPM_VERSION=$(jq -r .version < package.json)
        echo "ðŸ“¦ Publishing NPM version: $NPM_VERSION"
        npm ci
        npm test
        npm publish
        
    - name: ðŸ“¦ Prepare production dependencies for Docker
      run: |
        echo "ðŸ” Installing production dependencies..."
        npm ci --only=production
        echo "ðŸ“ Verifying node_modules exists:"
        ls -la node_modules/ | head -10


    - name: ðŸ” Debug Token Authentication Test
      run: |
        echo "=== ðŸ§ª TOKEN AUTHENTICATION DEBUG TEST ==="
        
        echo "ðŸ“‹ Step 1: Initial hello-world push test (should fail)"
        docker pull hello-world:latest
        docker tag hello-world:latest p1-flylnp1.jfrogdev.org/docker/hello-world:test-$(date +%s)
        TEST_TAG="p1-flylnp1.jfrogdev.org/docker/hello-world:test-$(date +%s)"
        docker tag hello-world:latest $TEST_TAG
        echo "Attempting initial push with fly-action auth..."
        docker push $TEST_TAG 2>&1 || echo "âŒ Initial push failed as expected"
        
        echo ""
        echo "ðŸ“‹ Step 2: Extract token from current creds and save to ENV"
        FLY_AUTH=$(jq -r '.auths["p1-flylnp1.jfrogdev.org"].auth' ~/.docker/config.json)
        EXTRACTED_TOKEN=$(echo $FLY_AUTH | base64 -d | cut -d: -f2)
        echo "::add-mask::$EXTRACTED_TOKEN"
        echo "Token extracted and masked âœ…"
        echo "EXTRACTED_FLY_TOKEN=$EXTRACTED_TOKEN" >> $GITHUB_ENV
        
        echo ""
        echo "ðŸ“‹ Step 3: Docker login with user 'michaelsv' and extracted token"
        echo "$EXTRACTED_TOKEN" | docker login https://p1-flylnp1.jfrogdev.org --username michaelsv --password-stdin
        echo "Login completed. Testing push..."
        TEST_TAG2="p1-flylnp1.jfrogdev.org/docker/hello-world:michaelsv-$(date +%s)"
        docker tag hello-world:latest $TEST_TAG2
        docker push $TEST_TAG2 2>&1 || echo "âŒ Push with michaelsv failed"
        
        echo ""
        echo "ðŸ“‹ Step 4: Docker login with user 'admin' and same token"
        echo "$EXTRACTED_TOKEN" | docker login https://p1-flylnp1.jfrogdev.org --username admin --password-stdin
        echo "Login completed. Testing push..."
        TEST_TAG3="p1-flylnp1.jfrogdev.org/docker/hello-world:admin-$(date +%s)"
        docker tag hello-world:latest $TEST_TAG3
        docker push $TEST_TAG3 2>&1 || echo "âŒ Push with admin failed"
        
        echo ""
        echo "ðŸ“‹ Step 5: Compare auth tokens in config"
        echo "Current Docker config auths:"
        cat ~/.docker/config.json | jq '.auths' || echo "No auths"
        
        echo ""
        echo "=== ðŸŽ¯ TOKEN TEST COMPLETE ==="
    - name: ðŸ³ Push Docker image
      run: |
        VERSION=$(date +"%Y.%m.%d-%H.%M.%S")
        echo "ðŸ“¦ Building and pushing Docker version: $VERSION"
        
        # Build Docker image (uses local build files)
        docker build -t ascii-frog .
        
        # Tag for both version and latest
        docker tag ascii-frog p1-flylnp1.jfrogdev.org/docker/ascii-frog:$VERSION
        # docker tag ascii-frog p1-flylnp1.jfrogdev.org/docker/ascii-frog:latest
        
        # Push both tags
        docker push p1-flylnp1.jfrogdev.org/docker/ascii-frog:$VERSION
        # docker push p1-flylnp1.jfrogdev.org/docker/ascii-frog:latest
        

    - name: ðŸ” Decode Auth Tokens  
      run: |
        echo "=== ðŸ” DECODING AUTH TOKENS ==="
        
        echo "ðŸ“‹ Fly-action auth token:"
        FLY_TOKEN=$(jq -r '.auths["p1-flylnp1.jfrogdev.org"].auth' ~/.docker/config.json)
        echo "Encoded: ${FLY_TOKEN:0:20}..."
        echo "Decoded username: $(echo $FLY_TOKEN | base64 -d | cut -d: -f1)"
        
        echo "ðŸ“‹ Explicit login auth token:"
        echo "${{ secrets.FLY_TOKEN }}" | docker login https://p1-flylnp1.jfrogdev.org --username admin --password-stdin > /dev/null 2>&1
        EXPLICIT_TOKEN=$(jq -r '.auths["p1-flylnp1.jfrogdev.org"].auth' ~/.docker/config.json)
        echo "Encoded: ${EXPLICIT_TOKEN:0:20}..."  
        echo "Decoded username: $(echo $EXPLICIT_TOKEN | base64 -d | cut -d: -f1)"
        
        echo "=== ðŸŽ¯ AUTH TOKEN COMPARISON COMPLETE ==="
