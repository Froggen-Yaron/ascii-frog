name: ğŸ”„ Reset to State Zero

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  reset-repository:
    name: Reset Repository to State Zero
    runs-on: linux-arm64
    
    steps:
    
    - name: ğŸ“¥ Checkout code with full history
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ”„ Reset to State Zero
      run: |
        echo "ğŸ¯ Resetting repository to state zero..."
        echo "Target branch: main-backup"
        
        # Configure git
        git config --global user.name "GitHub Actions"
        git config --global user.email "reset-to-state-zero@github.com"
        
        # Fetch the main-backup branch
        git fetch origin main-backup
        
        # Reset to the main-backup branch (state zero)
        git reset --hard origin/main-backup
        
        # Force push to main branch to reset it
        echo "ğŸš€ Force pushing reset to main branch..."
        git push --force origin HEAD:main

        
        echo "âœ… Repository reset to state zero complete"
        
    - name: ğŸ—‘ï¸ Delete add-random-color branches
      run: |
        echo "ğŸ—‘ï¸ Deleting branches with 'add-random-color' in name..."
        
        # Fetch all branches
        git fetch --all
        
        # Find and delete remote branches with 'add-random-color' in name
        echo "ğŸ“‹ Finding remote branches with 'add-random-color' on GitHub..."
        REMOTE_BRANCHES=$(git branch -r | grep "add-random-color" | sed 's/^\s*origin\///' | grep -v "HEAD" || true)
        
        if [ -n "$REMOTE_BRANCHES" ]; then
          echo "ğŸ” Found remote branches: $REMOTE_BRANCHES"
          for branch in $REMOTE_BRANCHES; do
            echo "ğŸ—‘ï¸ Deleting remote branch: origin/$branch"
            git push origin --delete "$branch" || echo "âš ï¸ Could not delete remote branch $branch"
          done
        else
          echo "â„¹ï¸ No remote branches with 'add-random-color' found"
        fi
        
        echo "âœ… Branch cleanup complete"
        
    - name: ğŸ§¹ Clean up workflow runs
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ§¹ Cleaning up old workflow runs..."
        
        # Get repository info
        REPO="${{ github.repository }}"
        
        # Get all workflow runs (keeping first 3)
        echo "ğŸ“Š Fetching workflow runs..."
        RUNS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/$REPO/actions/runs?per_page=100" | \
          jq -r '.workflow_runs[3:] | .[].id')
        
        # Delete old workflow runs
        echo "ğŸ—‘ï¸ Deleting old workflow runs (keeping first 3)..."
        COUNT=0
        for run_id in $RUNS; do
          echo "Deleting run: $run_id"
          curl -s -X DELETE \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/actions/runs/$run_id" || echo "âš ï¸ Could not delete run $run_id"
          COUNT=$((COUNT + 1))
        done
        
        echo "âœ… Cleaned up $COUNT workflow runs"
        echo "ğŸ’¡ Repository is now in state zero - ready for demo!"
        
    - name: ğŸ§¹ Clean up Artifactory artifacts
      env:
        FLY_TOKEN: ${{ secrets.FLY_TOKEN }}
      shell: bash
      run: |
        echo "ğŸ§¹ Cleaning up Artifactory artifacts..."
        
        # Make the script executable
        chmod +x .github/scripts/simple_cleanup.sh
        
        # Run the cleanup script in execution mode with bash
        echo "ğŸš€ Running Artifactory cleanup with bash..."
        bash ./.github/scripts/simple_cleanup.sh true
        
        echo "âœ… Artifactory cleanup complete"
        
    - name: ğŸ‰ State Zero Complete
      run: |
        echo "ğŸ¯ State Zero Reset Complete!"
        echo ""
        echo "âœ… Repository reset to main-backup branch state"
        echo "âœ… Workflow runs cleaned (kept first 3)"
        echo "âœ… All branches deleted (kept only main and main-backup)"
        echo "âœ… Artifactory artifacts cleaned up"
        echo ""
        echo "ğŸš€ Repository is ready for demo!"
